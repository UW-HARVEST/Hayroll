name: Smoke test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        llvm: [17, 18, 19]
    env:
      LLVM_VERSION: ${{ matrix.llvm }}
      SUDO: sudo
      NOSUDO:
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1
          show-progress: false
      - name: Remove old versions of clang and llvm
        run: |
          ./remove-all-llvm.bash $NOSUDO
      - name: Install curl
        run: |
          export DEBIAN_FRONTEND=noninteractive
          $SUDO apt update
          $SUDO apt install -y curl
      - name: Install Rust
        run: |
          curl -o rust-init.sh --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs
          sh ./rust-init.sh -y
      - run: ./prerequisites.bash $NOSUDO --latest --llvm-version=$LLVM_VERSION
      - run: ./build.bash
      - name: Run ctest
        run: |
          cd ./build
          ctest || ctest --rerun-failed --output-on-failure
      - name: Transpile LibmCS
        run: |
          pushd ../libmcs
          make clean
          bear -- make -j"$(nproc)"
          : > libm/include/config.h
          popd
          ./hayroll ../libmcs/compile_commands.json ./output/
      - name: Build Transpiled LibmCS
        run: |
          pushd ./output
          cargo build
          popd
